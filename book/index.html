<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>영어 책 뷰어</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      background-color: #f4f4f4;
      user-select: none; /* 복사 금지 */
    }
    #main {
      flex: 3;
      padding: 1.5rem;
      overflow-y: auto;
    }
    #vocab {
      flex: 1;
      padding: 1rem;
      background-color: #fff;
      border-left: 1px solid #ccc;
      overflow-y: auto;
    }
    h1, h2 {
      margin-top: 0;
    }
    .highlight-green { background-color: #d2f8d2; }
    .highlight-blue { background-color: #cce5ff; }
    .highlight-red { background-color: #ffc8cb; }
    .sentence {
      display: inline;
    }
    .sentence:hover {
      background-color: #efefef;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="main">
  <h1>📖 영어 책</h1>
  <div id="content">로딩 중...</div>
</div>

<div id="vocab">
  <h2>📚 단어장</h2>
  <ul id="word-list"></ul>
</div>

<script>
  async function loadTextFile(name) {
    const res = await fetch(`${name}.txt`);
    if (!res.ok) throw new Error("파일 불러오기 실패");
    return await res.text();
  }

  function sentenceSplit(text) {
    return text.split(/(?<=[.?!])\s+|\n\s*\n/).filter(s => s.trim());
  }

  function wrapSentences(text) {
    return sentenceSplit(text)
      .map(s => `<span class="sentence">${s.trim()}</span>`)
      .join(' ');
  }

  function updateVocabList() {
    const data = JSON.parse(localStorage.getItem('savedWords') || '{}');
    const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]);
    const list = document.getElementById('word-list');
    list.innerHTML = '';
    for (const [word, count] of sorted) {
      const li = document.createElement('li');
      li.textContent = `${word} (${count})`;
      list.appendChild(li);
    }
  }

  function highlightStoredWords() {
    const data = JSON.parse(localStorage.getItem('savedWords') || '{}');
    document.querySelectorAll('.sentence').forEach(span => {
      const words = span.textContent.split(/\b/);
      span.innerHTML = words.map(word => {
        const key = word.toLowerCase();
        const count = data[key];
        if (!count) return word;
        const cls = count >= 3 ? 'highlight-red' : count === 2 ? 'highlight-blue' : 'highlight-green';
        return `<span class="${cls}">${word}</span>`;
      }).join('');
    });
  }

  function tts(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    speechSynthesis.speak(utter);
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(location.search);
    const book = params.get('name') || 'thelittleprince';
    try {
      const raw = await loadTextFile(book);
      const paragraphs = raw.split(/\n\s*\n/)
        .map(p => wrapSentences(p.replace(/\n/g, ' ')));
      document.getElementById('content').innerHTML =
        paragraphs.map(p => `<p>${p}</p>`).join('\n');

      highlightStoredWords();
      updateVocabList();

      // 문장 클릭 → TTS
      document.getElementById('content').addEventListener('click', e => {
        if (e.target.classList.contains('sentence')) {
          tts(e.target.textContent);
        }
      });

      // 단어 더블 클릭 → 저장 및 강조
      document.getElementById('content').addEventListener('dblclick', e => {
        const sel = window.getSelection().toString().trim().toLowerCase();
        if (!/^[a-z]{2,}$/.test(sel)) return;
        const data = JSON.parse(localStorage.getItem('savedWords') || '{}');
        data[sel] = (data[sel] || 0) + 1;
        localStorage.setItem('savedWords', JSON.stringify(data));
        highlightStoredWords();
        updateVocabList();
      });

    } catch (err) {
      document.getElementById('content').textContent = '오류: ' + err.message;
    }
  });
</script>

</body>
</html>
