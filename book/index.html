<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>English Book Reader</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f2f2f2;
    }

    #container {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
    }

    #main {
      flex: 3;
      padding: 1rem;
      overflow-y: auto;
    }

    #vocab {
      flex: 1;
      background-color: #fff;
      border-left: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
    }

    h1, h2 {
      margin-top: 1rem;
    }

    .highlight-green { background-color: #ccffcc; }
    .highlight-blue { background-color: #cce5ff; }
    .highlight-red { background-color: #ffcccc; }

    .word:hover { cursor: pointer; background-color: #e0e0e0; }
    .sentence { display: block; margin-bottom: 0.5rem; }

    @media (max-width: 768px) {
      #container {
        flex-direction: column;
      }
      #vocab {
        border-left: none;
        border-top: 1px solid #ccc;
      }
    }
  </style>
</head>
<body>

<h1 style="padding: 1rem">üìñ ÏòÅÏñ¥ Ï±Ö</h1>
<div id="container">
  <div id="main">
    <div id="content">Loading...</div>
  </div>
  <div id="vocab">
    <ul id="word-list"></ul>
  </div>
</div>

<script>
  const wordCounts = JSON.parse(localStorage.getItem('wordCounts') || '{}');

  function updateWordStyle(span, word) {
    const count = wordCounts[word.toLowerCase()] || 0;
    span.classList.remove('highlight-green', 'highlight-blue', 'highlight-red');
    if (count === 1) span.classList.add('highlight-green');
    else if (count === 2) span.classList.add('highlight-blue');
    else if (count >= 3) span.classList.add('highlight-red');
  }

  function updateWordListDisplay() {
    const list = document.getElementById('word-list');
    list.innerHTML = '';
    Object.entries(wordCounts)
      .filter(([_, count]) => count > 0)
      .sort()
      .forEach(([word, _]) => {
        const li = document.createElement('li');
        li.textContent = word;
        list.appendChild(li);
      });
  }

  function parseMarkdown(text) {
    return text
      .replace(/^# (.*)$/gm, '<h1>$1</h1>')
      .replace(/^## (.*)$/gm, '<h2>$1</h2>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  }

  function sentenceSplit(text) {
    return text.split(/(?<=[.?!])\s+|\n\s*\n/).filter(s => s.trim().length > 0);
  }

  function wordWrap(sentence) {
    return sentence.split(/\b/).map(token => {
      if (/^[a-zA-Z]+$/.test(token)) {
        const span = document.createElement('span');
        span.classList.add('word');
        span.textContent = token;
        updateWordStyle(span, token);
        span.addEventListener('dblclick', () => {
          const lower = token.toLowerCase();
          wordCounts[lower] = (wordCounts[lower] || 0) + 1;
          localStorage.setItem('wordCounts', JSON.stringify(wordCounts));
          updateWordStyle(span, token);
          updateWordListDisplay();
        });
        return span.outerHTML;
      } else {
        return token;
      }
    }).join('');
  }

  async function loadTextFile(fileName) {
    const response = await fetch(fileName);
    if (!response.ok) throw new Error("ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
    return await response.text();
  }

  async function init() {
    const params = new URLSearchParams(location.search);
    const name = params.get('name');
    if (!name) {
      document.getElementById('content').textContent = 'Ï±Ö Ïù¥Î¶ÑÏù¥ ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§. Ïòà: ?name=thelittleprince';
      return;
    }

    try {
      const rawText = await loadTextFile(`${name}.txt`);
      const paragraphs = rawText.split(/\n\s*\n/);

      const contentHTML = paragraphs.map(p => {
        const sentences = sentenceSplit(p.replace(/\n/g, ' '));
        return sentences.map(s => `<span class="sentence">${wordWrap(s.trim())}</span>`).join(' ');
      }).map(p => `<p>${parseMarkdown(p)}</p>`).join('\n');

      document.getElementById('content').innerHTML = contentHTML;
      updateWordListDisplay();

    } catch (err) {
      document.getElementById('content').textContent = `ÏóêÎü¨: ${err.message}`;
    }
  }

  init();
</script>

</body>
</html>
