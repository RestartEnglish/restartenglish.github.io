<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>영어 책 뷰어</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: row;
      height: 100vh;
      background-color: #f2f2f2;
      user-select: none;
    }
    @media (max-width: 768px) {
      body { flex-direction: column; }
    }
    #main {
      flex: 3;
      padding: 1rem;
      overflow-y: scroll;
    }
    #vocab {
      flex: 1;
      background-color: #fff;
      border-left: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
    }
    .highlight-green { background-color: #ccffcc; }
    .highlight-blue { background-color: #cce5ff; }
    .highlight-pink { background-color: #ffd6e7; }
    strong { font-weight: bold; }
    h1, h2 { margin-top: 2rem; }
    .sentence:hover { cursor: pointer; background-color: #efefef; }
    li:hover { cursor: pointer; color: blue; }
    .word-info { margin-top: 1rem; font-size: 0.9rem; }
  </style>
</head>
<body>

<div id="main">
  <h1>📖 영어 책</h1>
  <div id="content">로딩 중...</div>
</div>

<div id="vocab">
  <h2>📚 단어</h2>
  <ul id="word-list"></ul>
  <div id="word-info" class="word-info"></div>
</div>

<script>
  const wordCounts = JSON.parse(localStorage.getItem('wordCounts') || '{}');

  async function loadTextFile(fileName) {
    const response = await fetch(fileName);
    if (!response.ok) throw new Error("파일을 불러올 수 없습니다.");
    return await response.text();
  }

  function parseMarkdown(text) {
    return text
      .replace(/^# (.*)$/gm, '<h1>$1</h1>')
      .replace(/^## (.*)$/gm, '<h2>$1</h2>')
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  }

  function sentenceSplit(text) {
    return text.split(/(?<=[.?!])\s+|\n\s*\n/).filter(s => s.trim().length > 0);
  }

  function wrapSentences(text) {
    const sentences = sentenceSplit(text);
    return sentences.map(s => `<span class="sentence">${s.trim()}</span>`).join(' ');
  }

  function getColor(count) {
    if (count >= 3) return 'highlight-pink';
    if (count === 2) return 'highlight-blue';
    return 'highlight-green';
  }

  function updateWordList() {
    const list = document.getElementById('word-list');
    list.innerHTML = '';
    Object.entries(wordCounts).forEach(([word, count]) => {
      const li = document.createElement('li');
      li.textContent = `${word} (${count})`;
      li.addEventListener('click', () => showWordInfo(word));
      list.appendChild(li);
    });
  }

  async function showWordInfo(word) {
    const infoBox = document.getElementById('word-info');
    infoBox.textContent = '로딩 중...';
    try {
      const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
      const data = await res.json();
      const entry = data[0];
      const phonetic = entry.phonetics?.[0]?.text || 'N/A';
      const meaning = entry.meanings?.[0]?.definitions?.[0]?.definition || 'No definition found.';
      infoBox.innerHTML = `<strong>${word}</strong><br>발음: ${phonetic}<br>뜻: ${meaning}`;
      const utter = new SpeechSynthesisUtterance(word);
      utter.lang = 'en-US';
      speechSynthesis.speak(utter);
    } catch {
      infoBox.textContent = '단어 정보를 가져올 수 없습니다.';
    }
  }

  function saveWord(word) {
    wordCounts[word] = (wordCounts[word] || 0) + 1;
    localStorage.setItem('wordCounts', JSON.stringify(wordCounts));
    updateWordList();
    return getColor(wordCounts[word]);
  }

  function applyWordHighlight() {
    document.querySelectorAll('.sentence').forEach(span => {
      span.innerHTML = span.textContent.split(/\b/).map(part => {
        const word = part.toLowerCase();
        if (wordCounts[word]) {
          return `<span class="${getColor(wordCounts[word])}">${part}</span>`;
        }
        return part;
      }).join('');
    });
  }

  function tts(text) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    speechSynthesis.speak(utter);
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(location.search);
    const name = params.get('name');
    if (!name) return document.getElementById('content').textContent = '책 이름이 필요합니다.';
    const rawText = await loadTextFile(`${name}.txt`);
    const content = document.getElementById('content');

    const paragraphs = rawText.split(/\n\s*\n/)
      .map(p => wrapSentences(p.replace(/\n/g, ' ').trim()))
      .map(html => parseMarkdown(html));

    content.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('\n');

    document.querySelectorAll('.sentence').forEach(span => {
      span.addEventListener('click', () => tts(span.textContent));
      span.addEventListener('dblclick', e => {
        e.preventDefault();           // ✅ 새로고침 방지
        e.stopPropagation();          // ✅ 이벤트 전파 방지

        
        const word = window.getSelection().toString().toLowerCase();
        if (word.match(/^[a-zA-Z]+$/)) {
          const color = saveWord(word);
          e.target.innerHTML = e.target.textContent.split(/\b/).map(part =>
            part.toLowerCase() === word ? `<span class="${color}">${part}</span>` : part
          ).join('');
        }
      });
    });

    updateWordList();
    applyWordHighlight();
  });
</script>

</body>
</html>
